<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Langfuse | Chi-Hsuan Chang </title> <meta name="author" content="Chi-Hsuan Chang"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://achchg.github.io/blog/2024/Langfuse/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Chi-Hsuan</span> Chang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Langfuse</h1> <p class="post-meta"> April 01, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/learn"> <i class="fa-solid fa-hashtag fa-sm"></i> learn</a>     ·   <a href="/blog/category/llm"> <i class="fa-solid fa-tag fa-sm"></i> llm</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I also explored Langfuse as an alternative to LangSmith, specifically the local host option, <a href="https://langfuse.com/docs/deployment/local" rel="external nofollow noopener" target="_blank">Self-host &gt; Local (docker compose)</a>.</p> <h4 id="pre-requisite-and-setup">Pre-requisite and setup</h4> <ul> <li>Getting started was easy. However, the default port used in localhost is port <code class="language-plaintext highlighter-rouge">3000</code>, which has been occupied in my case. Therefore, I modified <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> to map toward another local port, e.g. <code class="language-plaintext highlighter-rouge">3030</code>. Then again, <code class="language-plaintext highlighter-rouge">docker compose up</code>.</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ports:
      - "3030:3000"
</code></pre></div></div> <ul> <li>Now, we can access Langfuse at <code class="language-plaintext highlighter-rouge">http://localhost:3030</code> instead.</li> </ul> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/langfuse1-480.webp 480w,/assets/img/langfuse1-800.webp 800w,/assets/img/langfuse1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/langfuse1.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>You’d see the below screen and can click sign-up to setup a user account for local usage.</li> </ul> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/langfuse2-480.webp 480w,/assets/img/langfuse2-800.webp 800w,/assets/img/langfuse2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/langfuse2.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>After setting up an account and a project, here are some screenshots over the interface of langfuse and how you can go ahead and setup API keys for local dev usage.</li> </ul> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/langfuse4-480.webp 480w,/assets/img/langfuse4-800.webp 800w,/assets/img/langfuse4-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/langfuse4.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/langfuse5-480.webp 480w,/assets/img/langfuse5-800.webp 800w,/assets/img/langfuse5-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/langfuse5.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>Now that we have created the API keys, we just need to add <code class="language-plaintext highlighter-rouge">LANGFUSE_HOST</code>, <code class="language-plaintext highlighter-rouge">LANGFUSE_PUBLIC_KEY</code>, <code class="language-plaintext highlighter-rouge">LANGFUSE_SECRET_KEY</code> as environment variables and we’re ready to leverage langfuse.</li> </ul> <h4 id="if-youre-using-langchain">If you’re using Langchain</h4> <ul> <li> <p>No additional specification is needed once the environment variables are all set other than to import associated langfuse modules.</p> </li> <li> <p>For example, I made the followin example: Using the Chatllama agent using local llama2 docker image and Langchain:</p> </li> </ul> <pre><code class="language-{python}"># Import packages
from langchain_community.chat_models import ChatOllama
from langchain_core.output_parsers import StrOutputParser
from langchain_core.messages import HumanMessage
from langchain_core.prompts import ChatPromptTemplate

from langfuse import Langfuse
from langfuse.callback import CallbackHandler

# Setup Chatllama agent
llm = ChatOllama(model="llama2")

# Setup Prompt template
text = "You are a travel agent that help people prepare travel itinerary. {question}"
prompt = ChatPromptTemplate.from_template(text)

# Chain
chain = prompt | llm | StrOutputParser()

# Langfuse configuration to create Prompt logging
langfuse = Langfuse()
langfuse.create_prompt(
    name="ollama-test-prompt",
    prompt=text,
    is_active=True,
    config = {
        "model": "llama2",
        "temperature": 0.2,
        "supported_languages": ["en"]
    }
)

# Langfuse callback handler to allow traces
langfuse_handler = CallbackHandler(
    session_id="test-1234",
    user_id = "chi-local"
)

# Invoke the chain to answer the user question
print(chain.invoke({"question": "Travel plan for 6 days Iceland travel in June."}, 
config={"callbacks": [langfuse_handler]}))

</code></pre> <ul> <li>We’d found the running under the <code class="language-plaintext highlighter-rouge">localtest</code> project.As we have specified <code class="language-plaintext highlighter-rouge">langfuse.create_prompt</code> configurations, the prompt template and model config is logged under <code class="language-plaintext highlighter-rouge">Prompts</code>:</li> </ul> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/prompt-480.webp 480w,/assets/img/prompt-800.webp 800w,/assets/img/prompt-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/prompt.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>And We’d be able to see this execution logged on Langfuse in Traces as we have setup the CallbackHandler. This supports us keep track of the input, output, latency, number of tokens, cost and more.</li> </ul> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/tracedetail-480.webp 480w,/assets/img/tracedetail-800.webp 800w,/assets/img/tracedetail-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/tracedetail.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>Multiple executions under the same project can be tracked, which can used as a dashboard to support debugging for data scientists.</li> </ul> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/traces-480.webp 480w,/assets/img/traces-800.webp 800w,/assets/img/traces-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/traces.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Chi-Hsuan Chang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>